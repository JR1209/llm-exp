# Prompt上传功能测试指南

## ✅ 已实现的功能

### 1. 双输入方式
- ✅ **直接输入**：在文本框中手动输入prompt
- ✅ **上传文件**：支持拖拽或选择JSON/TXT文件

### 2. UI组件
- ✅ 选项卡切换（直接输入 / 上传文件）
- ✅ 文件拖拽区（支持拖放和点击）
- ✅ 文件信息显示（文件名）
- ✅ 应用/清除按钮

### 3. 生成和打分两处都支持
- ✅ 生成Prompt：步骤1右侧
- ✅ 打分Prompt：步骤3右侧

---

## 🧪 测试步骤

### 测试1：直接输入模式

1. 启动服务：`python3 start_simple.py`
2. 访问 `http://localhost:9123`
3. 在「生成Prompt」区域，点击「✍️ 直接输入」（默认已选中）
4. 在文本框输入：
```
你是一位专业的心理咨询师。
请根据用户的问题生成一段温暖、专业的对话。
对话应该包含共情、支持和引导。
```
5. 点击「✓ 应用Prompt」
6. 查看提示：「生成Prompt已保存」
7. 运行实验，验证自定义prompt是否生效

---

### 测试2：文件上传模式（TXT）

1. 创建测试文件 `test_gen_prompt.txt`：
```bash
cat > test_gen_prompt.txt << 'EOF'
你是一位资深的心理健康顾问。

任务：
- 理解用户的核心困扰
- 提供温暖的共情回应
- 给出实用的建议

风格：
- 温和、耐心
- 专业、可信
EOF
```

2. 在前端，点击「📁 上传文件」选项卡
3. 方式1：拖拽 `test_gen_prompt.txt` 到文件区域
4. 方式2：点击「选择文件」按钮，选择文件
5. 查看文件信息显示：「已选择：test_gen_prompt.txt」
6. 点击「✓ 应用Prompt」
7. 验证提示：「生成Prompt已保存」

---

### 测试3：文件上传模式（JSON）

1. 创建测试文件 `test_score_prompt.json`：
```bash
cat > test_score_prompt.json << 'EOF'
{
  "role": "专业心理咨询评估专家",
  "task": "对心理咨询对话进行多维度评分",
  "dimensions": [
    "共情度 (Empathy)",
    "支持性 (Supportiveness)",
    "引导性 (Guidance)",
    "安全性 (Safety)"
  ],
  "scoring_range": "0-10分",
  "instructions": "请基于对话的专业性、温暖度和有效性进行综合评估"
}
EOF
```

2. 在「打分Prompt」区域，点击「📁 上传文件」
3. 上传 `test_score_prompt.json`
4. JSON文件会被读取为文本内容
5. 点击「✓ 应用」
6. 运行实验，验证是否使用了自定义打分逻辑

---

### 测试4：清除功能

1. 在任一prompt区域输入或上传内容
2. 点击「✗ 清除」按钮
3. 验证：
   - 文本框内容已清空
   - 文件信息消失
   - 提示：「Prompt已清除」

---

### 测试5：模式切换

1. 在「直接输入」模式输入一些文字
2. 切换到「上传文件」模式
3. 上传一个文件
4. 再切换回「直接输入」模式
5. 验证：
   - 之前输入的文字仍然存在
   - 两种模式的内容独立保存

---

### 测试6：拖拽上传

1. 从文件管理器拖拽一个 `.txt` 或 `.json` 文件到文件区域
2. 拖拽时区域应高亮（黄色边框）
3. 松开鼠标后文件自动加载
4. 验证文件名显示正确

---

### 测试7：错误处理

1. 尝试上传 `.pdf` 或 `.docx` 文件
2. 应显示错误提示：「请上传JSON或TXT格式文件」
3. 文件不会被加载

---

### 测试8：完整流程

```bash
# 1. 创建自定义prompt文件
echo '你是温暖的心理咨询师，请用5轮对话深入理解用户。' > my_gen_prompt.txt
echo '请对整个对话的专业性和温暖度打分。' > my_score_prompt.txt

# 2. 启动服务
python3 start_simple.py
```

然后在前端：
1. 上传问题集（3个问题）
2. 生成配置：单模型，qwen-max，5轮
3. 生成Prompt：上传 `my_gen_prompt.txt`，点击应用
4. 打分配置：整体打分，3轮，Top-K=2
5. 打分Prompt：上传 `my_score_prompt.txt`，点击应用
6. 运行实验
7. 查看日志，确认使用了自定义prompt
8. 下载结果

---

## 📋 验收标准

### UI功能
- ✅ 选项卡切换流畅，视觉反馈清晰
- ✅ 文件拖拽区有悬停和拖拽时的高亮效果
- ✅ 文件上传后显示文件名
- ✅ 清除按钮能清空所有内容

### 文件处理
- ✅ 支持 `.txt` 和 `.json` 文件
- ✅ 拒绝其他格式文件，显示错误提示
- ✅ 文件内容正确读取（UTF-8编码）

### 后端集成
- ✅ 无论哪种输入方式，最终都通过同一个API保存
- ✅ 自定义prompt能正确传递到生成/打分函数
- ✅ 实验日志中显示使用了自定义prompt

### 用户体验
- ✅ 操作直观，不需要说明文档
- ✅ 提示信息清晰（成功/失败/文件名）
- ✅ 响应迅速，无卡顿

---

## 🎯 技术实现细节

### 前端
- 选项卡切换：`data-tab` 和 `data-prompt` 属性
- 文件读取：`FileReader.readAsText()`
- 拖拽处理：`dragover`, `dragleave`, `drop` 事件
- 模式管理：`genPromptMode` 和 `scorePromptMode` 变量

### 后端
- API接口不变：`/api/prompts/generation` 和 `/api/prompts/scoring`
- 无论输入方式如何，都接收纯文本内容
- 保存到临时文件：`temp_generation_prompt.txt` 和 `temp_scoring_prompt.txt`

### 参数传递
- 前端调用 `uploadGenerationPrompt()` 时自动判断模式
- 从文本框或文件变量获取内容
- POST到后端API
- 后端保存后，主脚本通过 `--generation-prompt-file` 参数读取

---

**所有功能已就绪，开始测试！** 🚀
